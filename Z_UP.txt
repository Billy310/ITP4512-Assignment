*&---------------------------------------------------------------------*
*& REPORT  Z_YUENTATSHINGBILLY_UP                                      *
*&                                                                     *
*&---------------------------------------------------------------------*
*&                                                                     *
*&                                                                     *
*&---------------------------------------------------------------------*

REPORT  Z_YUENTATSHINGBILLY_UP                  .

TABLES: SCARR,SPFLI,SFLIGHT,SBOOK.

DATA: I_EARNING TYPE F.



TYPES: BEGIN OF TY_ZASG,
MANDT TYPE MANDT,
CARRID TYPE S_CARRID,
CONNID TYPE S_CONN_ID,
FLDATE TYPE SFLIGHT-FLDATE,
CUSTOMID TYPE S_CUSTOMER,
CARRNAME TYPE S_CARRNAME,
FLTIME TYPE S_FLTIME,
LUGGWEIGHT TYPE S_LUGWEIGH,
WUNIT TYPE S_WEIUNIT,
PASSNAME TYPE S_PASSNAME,
H_FLAG TYPE FLAG,
HKEARNING TYPE S_L_CUR_PR,
CURRENCY TYPE S_CURRCODE,
PLANETYPE TYPE S_PLANETYE,
END OF TY_ZASG.

DATA ITAB1 TYPE TABLE OF TY_ZASG.

DATA WA1 TYPE TY_ZASG.


TYPES: BEGIN OF TY_CURR,
LOCALCURRENCY TYPE S_CURRCODE,
LOCCURAM TYPE SBOOK-LOCCURAM,
PRICE TYPE SFLIGHT-PRICE,

END OF TY_CURR.

DATA ITAB2 TYPE TABLE OF TY_CURR.

DATA WA2 TYPE TY_CURR.

SELECT SFLIGHT~MANDT SFLIGHT~CARRID SFLIGHT~CONNID SBOOK~FLDATE CUSTOMID
 CARRNAME FLTIME LUGGWEIGHT WUNIT PASSNAME CURRENCY PLANETYPE FROM SCARR
 INNER JOIN SPFLI ON SCARR~CARRID = SPFLI~CARRID
 INNER JOIN SFLIGHT ON SPFLI~CONNID = SFLIGHT~CONNID
 INNER JOIN SBOOK ON SFLIGHT~FLDATE = SBOOK~FLDATE
 INTO CORRESPONDING FIELDS OF TABLE ITAB1.


SELECT SBOOK~LOCCURKEY SBOOK~LOCCURAM   SFLIGHT~PRICE FROM SBOOK
INNER JOIN SFLIGHT ON
SFLIGHT~FLDATE = SBOOK~FLDATE
INTO TABLE ITAB2.

DATA TEMP_EARNING TYPE S_L_CUR_PR.

LOOP AT ITAB2 INTO WA2.

READ TABLE ITAB1 INTO WA1 INDEX SY-TABIX.

TEMP_EARNING = WA2-LOCCURAM - WA2-PRICE.

CALL FUNCTION 'Z_YUENTATSHINGBILLY_FN1'
  EXPORTING
    I_CURRENCY             = WA2-LOCALCURRENCY
    I_EARNING              =  TEMP_EARNING
 IMPORTING
   O_EARNING              = WA1-HKEARNING
 EXCEPTIONS
   INCORRECT_INPUT        = 1
   NOTSUPPORT_VALUE       = 2
   OTHERS                 = 3
          .
IF SY-SUBRC <> 0.

ENDIF.


CALL FUNCTION 'Z_YUENTATSHINGBILLY_FN2'
  EXPORTING
    I_WTUNIT         = WA1-WUNIT
    I_LWEIGHT        = WA1-LUGGWEIGHT
 IMPORTING
   O_LGWEIGHT       = WA1-LUGGWEIGHT
          .




IF WA1-FLTIME >  660 OR WA1-LUGGWEIGHT > 14.
WA1-H_FLAG = 'X'.
ELSE.
WA1-H_FLAG = ''.
ENDIF.


MODIFY ITAB1 FROM WA1 INDEX SY-TABIX.
ENDLOOP.

INSERT ZASG_210347150 FROM TABLE ITAB1.